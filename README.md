
---

# Branding-Blends

## Branding_Brends_Backend

肌状態と髪の清潔感をAIで自動評価するWebアプリのバックエンドです。  
ユーザーがアップロードした顔画像から、AIが3つの観点（肌、髪、髭）をスコアリングし、結果を返却・保存します。
こちらのフロントエンドと接続します。
https://github.com/showheysas/BBB-Frontend

---

### 🧠 このプロジェクトでやっていること

#### 1. 学習済みモデルの活用

本アプリは、PyTorchで学習した以下の分類モデルを活用しています：

| モデル                  | 分類内容                     | 使用手法                     | 備考                                |
|-------------------------|------------------------------|------------------------------|-------------------------------------|
| Skin Classifier         | 肌質（乾燥肌・脂性肌・普通肌） | CNN（畳み込みニューラルネットワーク） | データ拡張あり                     |
| Hair Cleanliness Classifier | 髪の清潔感（清潔 / 非清潔）   | 転移学習（ResNet18）          | データ不均衡に対応、交差検証あり   |

モデル学習は、FastAPIのプロジェクトとは別のローカルリポジトリで学習を行い、`pth` (PyTorch)形式のファイルを出力しています。  
これらのモデルは `.pth` ファイルとして `backend/models/` に保存されており、FastAPI のエンドポイントに組み込まれています。  

---

#### 2. FastAPIでの推論エンドポイント

ユーザーの顔画像を受け取り、以下の処理を行う `/upload` エンドポイントを提供しています：

1. 顔領域の検出・クロッピング（`face_recognition` 使用）  
2. 学習済みモデルによる肌・髪の分類  
3. 髭は現状ダミースコア（80点）を返す仕様  
4. 各スコアと合計スコアの計算  
5. 画像とスコアをDBに保存（SQLAlchemy）  

レスポンスとして、`transaction_id` を返します。

---

### 🔑 認証エンドポイント (`auth.py`)

#### **1. ユーザー登録**
- **エンドポイント**: `/register`
- **説明**: 新規ユーザーを登録します。
- **リクエスト**: ユーザー情報 (`user_id`, `password`, `name`) を送信。
- **レスポンス**: 登録成功メッセージと `user_id` を返却。

#### **2. ログイン**
- **エンドポイント**: `/login`
- **説明**: 登録済みユーザーがログインし、アクセストークンを取得します。
- **リクエスト**: ユーザーIDとパスワード。
- **レスポンス**: JWT形式のアクセストークン。

#### **3. 保護されたルート**
- **エンドポイント**: `/protected`
- **説明**: トークン検証後にアクセス可能な保護されたルート。
- **リクエスト**: Authorizationヘッダーにトークンを含めて送信。
- **レスポンス**: 認証成功メッセージ。

---

### 📊 結果取得エンドポイント (`result.py`)

#### **1. 結果取得**
- **エンドポイント**: `/{transaction_id}`
- **説明**: 特定のトランザクションIDに基づいて評価結果を取得します。
- **リクエスト**: トランザクションIDと認証トークン。
- **レスポンス**:
  - 各項目（肌状態、髪状態、髭状態）のスコア（10点満点および100点満点）。
  - スコアに基づいたコメント。
  - トータルスコアとそのコメント。

#### **コメント生成**
スコアに応じて以下のようなコメントがランダムに生成されます：
- **90点以上**: 素晴らしい状態です！理想的なコンディションです！
- **75点以上**: 良好な状態です。この調子で頑張りましょう！
- **それ以下**: 改善の余地があります。一緒に頑張りましょう！

---

### 🔧 ディレクトリ構成と主な役割

```
backend/
├── app/               # FastAPI本体のコード群
│   ├── api/           # APIエンドポイント定義（upload, result, auth）
│   ├── core/          # アプリの設定や認証処理（JWT検証など）
│   ├── db/            # DB接続・モデル定義・CRUD操作
│   ├── schemas/       # Pydanticによるリクエスト/レスポンス定義
│   └── main.py        # FastAPI起動スクリプト（エントリーポイント）
│
├── models/            # 学習済みモデルの保存場所（.pthファイル）　github未連携
│   ├── skin_classifier_model.pth
│   ├── hair_classifier_cleanliness.pth
│   └── beard_classifier.pth（※未使用）
│
├── requirements.txt   # 使用ライブラリ一覧
└── .env               # 環境変数（APIキーやDB接続文字列など）
```

---

### 🌟 FaceRecognitionとOpenCVによる画像処理

#### 顔領域検出と前処理
- 顔画像はOpenCVとFaceRecognitionライブラリで処理されます。
- 顔領域拡張後に切り取り・リサイズし、PIL形式で正規化処理。

---

### 📌 備考

- `beard_classifier.pth` は現時点で未使用です（今後拡張予定）。  
- 顔検出には dlib ベースの `face_recognition` を利用しています。  

---
